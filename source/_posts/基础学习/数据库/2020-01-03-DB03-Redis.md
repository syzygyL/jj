---
title: DB03-Redis
tags:
  - note
  - NoSQL
comments: false
categories:
  - 基础学习
  - 数据库
date: 2020-01-03 20:28:54
description:
top:
---

# Redis

## Redis 简介

Redis 是一个使用 C 语言编写 、 遵守 BSD 协议、支持网络、可基于内存亦可持久化的日志型、Key-Value 非关系型数据库

{% note success %} 
什么是 BSD 协议?
BSD 开源协议是一个给于使用者很大自由的协议。可以自由的使用，修改源代码，也可以将修改后的代码作为开源或者专有软件再发布
{% endnote %}

### NoSQL
NoSQL = Not Only SQL（非关系型数据库），去除了关系数据库的关系型特性的数据库，NoSQL 不保证关系数据的 ACID 特性，大部分不提供事务的管理，与关系型数据库形成互补关系，通常 NoSQL 数据库都具有以下几点特征：**易扩展、大数据量，高性能、数据模型灵活、高可用**

| NoSQL 分类 | K/V存储数据库|列存储数据库  |文档型数据库|图形(Graph)数据库|
|-----------|--------------|-----|--------|---------------------|
|**典型产品**| **Redis**       |HBase| MongoDb|            Neo4J|
|**应用场景**|内容缓存，日志系统|分布式文件系统|Web应用|社交网络|

### Redis 较其他 K/V 数据库的优势
Redis 有着更为复杂的数据结构并且提供对他们的原子性操作
Redis 的数据类型都是基于基本数据结构的同时对程序员透明，无需进行额外的抽象
Redis 运行在内存中还可以持久化到磁盘

## Redis 初使用

### 下载安装

1. 官网 https://redis.io  或者中文网 http://www.redis.net.cn/
2. 下载之后解压，在解压目录找到 `redis-server.exe` 这是 Redis 的服务器端，双击运行可以看到 Redis 的命令行界面，上面有进程 ID 和端口号，不要关闭此窗口
3. 找到 `redis-cli.exe` 这是 Redis 的客户端，双击即可看到已连接到 Redis 服务器的端口 127.0.0.1:6379>，说明已成功安装 Redis

### 配置

Windows 下的 Redis 配置文件：`redis.windows.conf `

## Redis 数据的形式
Redis 存储的是 key+value 格式的数据，其中 key 固定为字符串 ，value 则有 5 种数据类型

### value 的数据类型

**字符串： string**（二进制安全）
二进制安全的意思是 Redis 的 string 可以包含任何数据，比如 jpg 图片或者序列化的对象，string 类型是 Redis 最基本的数据类型， 最大能存储 512MB

**哈希： hash**（类似`map`类型） 场景：查、增、改用户的属性

**有序列表： list**（类似`LinkedList`格式，双向链表，元素可重复）场景：消息队列

**无序集合： set**(类似`HashSet`格式，哈希表实现，元素不允许重复，无序) 场景：两个用户之间的共同好友数

**有序集合： zset(sorted set)**(不允许重复，通过增加权重 score， 使存储元素从小到大排序) 场景：排行榜

## Redis 常见命令操作

### 通用命令
`keys *` : 查询所有键
`type key` ： 获取键对应值的数据类型
`del key`：删除指定键

### 操作字符串类型数据

**存储**：`set key value`
```sql
127.0.0.1:6379> set username zhangsan
OK
```
**获取**：`get key`
```sql
127.0.0.1:6379> get username
"zhangsan"
```
**删除**：`del key`
```sql
127.0.0.1:6379> del username
(integer) 1
```
### 操作哈希类型数据

**存储**：`hset key field value`
```sql
127.0.0.1:6379> hset myhash username lisi
(integer) 1
127.0.0.1:6379> hset myhash password 1234
(integer) 1
```
**获取**：
`hget key field` 获取指定的field对应的值
```sql
127.0.0.1:6379> hget myhash username
"lisi"
```
`hgetall key` 获取所有的 field 和 value
```sql
127.0.0.1:6379> hgetall myhash
1) "username"
2) "lisi"
3) "password"
4) "123"
```
**删除**：`hdel key field`
```sql
127.0.0.1:6379> hdel myhash password
(integer) 1
```

### 操作有序列表类型数据

**添加**：
`lpush key value` 将元素加入列表的左边
```sql
127.0.0.1:6379> lpush myList a
(integer) 1
127.0.0.1:6379> lpush myList b
(integer) 2
```
`rpush key value` 将元素加入列表的右边
```sql
127.0.0.1:6379> rpush myList c
(integer) 3
```					
**获取**：
`lrange key start end` 范围获取
```sql
127.0.0.1:6379> lrange myList 0 -1
1) "b"
2) "a"
3) "c"
```
**删除**：
`lpop key` 删除列表最左边的元素，并将元素返回
`rpop key` 删除列表最右边的元素，并将元素返回

### 操作无序集合类型数据

**存储**：`sadd key value`
```sql
127.0.0.1:6379> sadd myset a
(integer) 1
127.0.0.1:6379> sadd myset a
(integer) 0
```
**获取**:
`smembers key` 获取set集合中所有元素
```sql
127.0.0.1:6379> smembers myset
1) "a"
```
**删除**：
`srem key value` 删除set集合中的某个元素
```sql
127.0.0.1:6379> srem myset a
(integer) 1
```

### 操作有序集合类型数据
**存储**：
`zadd key score value` 存储元素时指定权重 ， score:分数
```sql
127.0.0.1:6379> zadd mysort 60 zhangsan
(integer) 1
127.0.0.1:6379> zadd mysort 50 lisi
(integer) 1
127.0.0.1:6379> zadd mysort 80 wangwu
(integer) 1
```
**获取**：`zrange key start end [withscores]` 可通过携带 withscores 查看对应元素权重
```sql
127.0.0.1:6379> zrange mysort 0 -1
1) "lisi"
2) "zhangsan"
3) "wangwu"

127.0.0.1:6379> zrange mysort 0 -1 withscores
1) "zhangsan"
2) "60"
3) "wangwu"
4) "80"
5) "lisi"
6) "500"
```
**删除**：`zrem key value`
```sql
127.0.0.1:6379> zrem mysort lisi
(integer) 1
```

## Redis 持久化

### RDB
RDB (快照)持久化：保存某个时间点的全量数据快照
默认持久化方式，不需要进行配置，默认就使用这种机制，原理就是：在一定的间隔时间中，检测 key 的变化情况，然后持久化数据

<label style="color:#4285f4">编辑</label> `redis.windwos.conf` 文件：找到下面的配置，它们设置了在某个时间段内多少个 key 发生改变就会触发 RDB 持久化，我们按需求改变某种触发机制

```text
#   after 900 sec (15 min) if at least 1 key changed  #15分钟内有1个键发生改变则触发 RDB
save 900 1
#   after 300 sec (5 min) if at least 10 keys changed #5分钟内有10个键发生改变则触发 RDB
save 300 10
#  after 60 sec if at least 10000 keys changed        #1分钟内有10000个键发生改变则触发 RDB
save 60 10000
```

<label style="color:red">重启</label> Redis 服务器：根目录下进入 cmd 输入以下命令(指定 Redis 服务器加载时的配置文件)

```text
D:\work\Redis>redis-server.exe redis.windows.conf
```


### AOF

AOF(Append-Only-File) 持久化：可以记录每条命令的操作，以日志形式追加保存到 AOF 文件中（增量）

<label style="color:#4285f4">编辑</label> `redis.windwos.conf` 文件：找到 appendonly no（关闭 AOF ） 修改为 appendonly yes （开启 AOF ）

```text
# appendfsync always         # 每一次操作都进行持久化
appendfsync everysec         # 每隔一秒进行一次持久化
# appendfsync no	     # 将不进行持久化 去掉 ＃ 改为 yes
appendfsync yes    
```
## Java 连接 Redis

1. 导入 jar 包
2. 创建 Jedis 对象
3. 操作 Redis 数据库
4. 断开连接

```java
Jedis jedis = new Jedis("localhost", 6379);
jedis.set("name","lisi");
jedis.close();
```
### 常用方法

#### 字符串

存储：set(K,V) 

获取：V get(K)

设置键的过期时间：setex(K,outtime,V) 

#### 哈希

存储：hset(K,Field,V)

获取：V hget(K,Field)

获取所有：Map< String,String > hgetAll(K)

#### 有序列表

从列表左边依次开始存储（ Vn 为最左边的元素）：lpush(K,V1,V2...Vn) 

从列表左边依次开始存储（ Vn 为最右边的元素）：rpush(K,V1,V2...Vn) 

范围获取（ 0 到 -1 代表获取所有）：List< String > lrange(K,0,-1) 

弹出最左边的元素：V lpop(K) 

弹出最右边的元素：V rpop(K) 


#### 无序集合

存储：sadd(K,V1,V2...Vn) 

获取所有：Set< String > smembers(K)


#### 有序集合

存储：zadd(K,SCORE,V)

范围获取（ 0 到 -1 代表获取所有）：Set< String > zrange(K,0,-1)

### JedisPool 连接池
1.导入 commons-poolx-x.x.jar 包
2.创建 JedisPool 连接池对象
3.调用方法 getResource() 获取 Jedis 连接

```java
//0.创建一个配置对象
JedisPoolConfig config = new JedisPoolConfig();
config.setMaxTotal(60);
config.setMaxIdle(20);
//1.创建 Jedis 连接池对象
JedisPool jedisPool = new JedisPool(config,"localhost",6379);
//2. 获取连接
Jedis jedis = jedisPool.getResource();
//3. 操作 Redis
jedis.set("name","honey");
//4. 归还到连接池中
jedis.close();
```
可以发现每次使用连接池时都要新建连接池，为了避免频繁创建造成不必要的开销，便于管理，可以使用连接池工具类优化

1)<label style="color:green">创建</label>  配置文件 `jedis.properties`

```properties
# 主机IP
host=127.0.0.1
# 端口号
port=6379
# 最大连接数
maxTotal=50
# 最大闲置连接数
maxIdle=10
```
2)<label style="color:green">创建</label>  工具类 `JedisPoolUtil`
```java
public class JedisPoolUtil
{
  private JedisPoolUtil() {}

  private static JedisPool jedisPool;
  // 类加载时读取配置文件
  static {
      InputStream is = JedisPoolUtil.class.getClassLoader().getResourceAsStream("jedis.properties");
      Properties prop = new Properties();
      try {
          prop.load(is);
      } catch (IOException e) {
          e.printStackTrace();
      }
      JedisPoolConfig config = new JedisPoolConfig();
      
      int maxIdle = Integer.parseInt(prop.getProperty("maxIdle"));
      int maxTotal = Integer.parseInt(prop.getProperty("maxTotal"));
      int port = Integer.parseInt(prop.getProperty("port"));
      String host = prop.getProperty("host");

      config.setMaxIdle(maxIdle);
      config.setMaxTotal(maxTotal);
      jedisPool = new JedisPool(config, host, port);
  }
  // 获取 Jedis 连接
  public static Jedis getJedis(){
      return jedisPool.getResource();
  }
}
```

3)<label style="color:#1cb7ff">使用</label> 连接池工具类

```java
@Test
public void test1(){
    Jedis jedis = JedisPoolUtil.getJedis();
    jedis.set("Hello","World");
    jedis.close();
}
```